<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Sofi Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #0e1621;
      color: #fff;
    }

    header {
      background: #17212b;
      padding: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    header img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }

    #container {
      display: flex;
      height: calc(100vh - 60px);
    }

    #chatList {
      width: 35%;
      background: #17212b;
      overflow-y: auto;
      border-right: 1px solid #222;
    }

    .chat-item {
      padding: 10px;
      border-bottom: 1px solid #222;
      cursor: pointer;
    }

    .chat-item:hover {
      background: #1f2c3a;
    }

    #chat {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    #messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
    }

    .msg {
      margin-bottom: 8px;
    }

    .me {
      text-align: right;
    }

    .status {
      font-size: 12px;
      margin-left: 5px;
      color: #4fc3f7;
    }

    #typingStatus {
      padding: 5px 10px;
      font-size: 13px;
      display: none;
      color: #aaa;
    }

    #inputArea {
      display: flex;
      padding: 10px;
      background: #17212b;
    }

    #messageInput {
      flex: 1;
      padding: 8px;
      border-radius: 5px;
      border: none;
    }

    button {
      margin-left: 5px;
      padding: 8px;
      background: #4fc3f7;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      background: #39a9dd;
    }
  </style>
</head>
<body>

<header>
  <img id="myPhoto">
  <span id="myName"></span>
  <button id="loginBtn">Login Google</button>
</header>

<div id="container">
  <div id="chatList"></div>

  <div id="chat">
    <div id="messages"></div>
    <div id="typingStatus">Digitando...</div>
    <div id="inputArea">
      <input id="messageInput" placeholder="Digite uma mensagem">
      <button id="sendBtn">Enviar</button>
    </div>
  </div>
</div>

<!-- FIREBASE -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import {
    getAuth,
    signInWithPopup,
    GoogleAuthProvider,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

  import {
    getFirestore,
    collection,
    doc,
    setDoc,
    getDoc,
    getDocs,
    addDoc,
    updateDoc,
    onSnapshot,
    query,
    where,
    orderBy,
    serverTimestamp,
    arrayUnion
  } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

  // ðŸ”‘ SUA CONFIG
  const firebaseConfig = {
    apiKey: "AIzaSyDwsERnH6Obpzc6Klt9r7IxDXWOkiaYSHU",
    authDomain: "sofi-chat.firebaseapp.com",
    projectId: "sofi-chat",
    storageBucket: "sofi-chat.firebasestorage.app",
    messagingSenderId: "533851013944",
    appId: "1:533851013944:web:a49900cdde03ba01dd37cd"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth();
  const db = getFirestore();

  const loginBtn = document.getElementById("loginBtn");
  const myPhoto = document.getElementById("myPhoto");
  const myName = document.getElementById("myName");
  const chatList = document.getElementById("chatList");
  const messagesDiv = document.getElementById("messages");
  const messageInput = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");
  const typingStatus = document.getElementById("typingStatus");

  let user;
  let chatId;
  let typingTimer;

  loginBtn.onclick = async () => {
    const provider = new GoogleAuthProvider();
    await signInWithPopup(auth, provider);
  };

  onAuthStateChanged(auth, async (u) => {
    if (!u) return;
    user = u;

    myPhoto.src = user.photoURL;
    myName.innerText = user.displayName;
    loginBtn.style.display = "none";

    await setDoc(doc(db, "users", user.uid), {
      name: user.displayName,
      photoURL: user.photoURL,
      online: true
    }, { merge: true });

    loadChats();
  });

  async function loadChats() {
    const q = query(
      collection(db, "chats"),
      where("users", "array-contains", user.uid)
    );

    onSnapshot(q, snap => {
      chatList.innerHTML = "";
      snap.forEach(docSnap => {
        const chat = docSnap.data();
        const div = document.createElement("div");
        div.className = "chat-item";

        const checks = chat.lastReadBy?.length > 0 ? "âœ”âœ”" : "âœ”";
        div.innerText = `${chat.lastMessage || "Nova conversa"} ${checks}`;
        div.onclick = () => openChat(docSnap.id, chat);
        chatList.appendChild(div);
      });
    });
  }

  function openChat(id, chat) {
    if (!chat.users.includes(user.uid)) {
      alert("Acesso negado");
      return;
    }

    chatId = id;
    messagesDiv.innerHTML = "";

    onSnapshot(
      query(
        collection(db, "chats", chatId, "messages"),
        orderBy("createdAt")
      ),
      snap => {
        messagesDiv.innerHTML = "";
        snap.forEach(docSnap => {
          const msg = docSnap.data();
          const div = document.createElement("div");
          div.className = "msg " + (msg.sender === user.uid ? "me" : "");
          div.innerText = msg.text;

          if (msg.sender === user.uid) {
            const s = document.createElement("span");
            s.className = "status";
            s.innerText = msg.readBy?.length ? "âœ”âœ”" : "âœ”";
            div.appendChild(s);
          } else if (!msg.readBy?.includes(user.uid)) {
            updateDoc(doc(db, "chats", chatId, "messages", docSnap.id), {
              readBy: arrayUnion(user.uid)
            });
          }

          messagesDiv.appendChild(div);
        });
      }
    );

    onSnapshot(doc(db, "chats", chatId), snap => {
      const typing = snap.data().typing || {};
      const other = chat.users.find(u => u !== user.uid);
      typingStatus.style.display = typing[other] ? "block" : "none";
    });
  }

  sendBtn.onclick = async () => {
    if (!chatId || !messageInput.value) return;

    const text = messageInput.value;
    messageInput.value = "";

    await addDoc(collection(db, "chats", chatId, "messages"), {
      text,
      sender: user.uid,
      createdAt: serverTimestamp(),
      readBy: []
    });

    await updateDoc(doc(db, "chats", chatId), {
      lastMessage: text,
      lastSender: user.uid,
      lastTimestamp: serverTimestamp(),
      lastReadBy: [],
      [`typing.${user.uid}`]: false
    });
  };

  messageInput.addEventListener("input", async () => {
    if (!chatId) return;

    await updateDoc(doc(db, "chats", chatId), {
      [`typing.${user.uid}`]: true
    });

    clearTimeout(typingTimer);
    typingTimer = setTimeout(async () => {
      await updateDoc(doc(db, "chats", chatId), {
        [`typing.${user.uid}`]: false
      });
    }, 1500);
  });
</script>
</body>
</html>