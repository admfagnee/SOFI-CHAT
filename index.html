<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SOFI Chat</title>

<style>
:root{
  --primary:#667eea;
  --secondary:#764ba2;
  --bg:#f5f7fa;
}

body{
  margin:0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
  background:var(--bg);
}

#login{
  height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  background:linear-gradient(135deg,var(--primary),var(--secondary));
}

.login-box{
  background:white;
  padding:30px;
  border-radius:16px;
  text-align:center;
  width:90%;
  max-width:350px;
}

button{
  padding:12px 20px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  background:linear-gradient(135deg,var(--primary),var(--secondary));
  color:white;
  font-weight:600;
}

#app{
  display:none;
  height:100vh;
}

.sidebar{
  width:320px;
  background:white;
  border-right:1px solid #ddd;
  overflow-y:auto;
}

.chat{
  flex:1;
  display:flex;
  flex-direction:column;
}

header{
  padding:15px;
  background:white;
  border-bottom:1px solid #ddd;
  display:flex;
  align-items:center;
  gap:10px;
}

.messages{
  flex:1;
  padding:15px;
  overflow-y:auto;
}

.msg{
  max-width:70%;
  margin-bottom:10px;
  padding:10px 14px;
  border-radius:18px;
  font-size:14px;
}

.me{
  margin-left:auto;
  background:linear-gradient(135deg,var(--primary),var(--secondary));
  color:white;
}

.other{
  background:white;
  box-shadow:0 2px 6px rgba(0,0,0,.1);
}

.input{
  display:flex;
  padding:10px;
  gap:10px;
  background:white;
}

input{
  flex:1;
  padding:12px;
  border-radius:20px;
  border:1px solid #ccc;
}
</style>
</head>

<body>

<div id="login">
  <div class="login-box">
    <h2>SOFI Chat</h2>
    <button id="googleLogin">Entrar com Google</button>
  </div>
</div>

<div id="app" style="display:flex">
  <div class="sidebar" id="conversations"></div>
  <div class="chat">
    <header>
      <img id="chatPhoto" width="40" height="40" style="border-radius:50%">
      <div>
        <div id="chatName"></div>
        <small id="typing"></small>
      </div>
    </header>
    <div class="messages" id="messages"></div>
    <div class="input">
      <input id="text" placeholder="Mensagem..." />
      <button id="send">âž¤</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, query, where, orderBy, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDwsERnH6Obpzc6Klt9r7IxDXWOkiaYSHU",
  authDomain: "sofi-chat.firebaseapp.com",
  projectId: "sofi-chat",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

const login = document.getElementById("login");
const appUI = document.getElementById("app");

document.getElementById("googleLogin").onclick = async ()=>{
  await signInWithPopup(auth,new GoogleAuthProvider());
};

let user, currentChat;

onAuthStateChanged(auth, async u=>{
  if(!u) return;
  user = u;
  login.style.display="none";
  appUI.style.display="flex";

  await setDoc(doc(db,"users",u.uid),{
    name:u.displayName,
    photo:u.photoURL,
    online:true,
    lastSeen:serverTimestamp()
  });

  loadChats();
});

function loadChats(){
  const q = query(collection(db,"conversations"), where("users","array-contains",user.uid));
  onSnapshot(q,snap=>{
    conversations.innerHTML="";
    snap.forEach(d=>{
      const c=d.data();
      const div=document.createElement("div");
      div.innerText=c.lastMessage||"Nova conversa";
      div.onclick=()=>openChat(d.id,c);
      conversations.appendChild(div);
    });
  });
}

function openChat(id,c){
  currentChat=id;
  chatName.innerText=c.name;
  messages.innerHTML="";
  const q=query(collection(db,"conversations",id,"messages"),orderBy("createdAt"));
  onSnapshot(q,s=>{
    messages.innerHTML="";
    s.forEach(m=>{
      const d=m.data();
      const div=document.createElement("div");
      div.className="msg "+(d.from===user.uid?"me":"other");
      div.innerText=d.text;
      messages.appendChild(div);
    });
  });
}

send.onclick=async ()=>{
  if(!text.value) return;
  await addDoc(collection(db,"conversations",currentChat,"messages"),{
    text:text.value,
    from:user.uid,
    createdAt:serverTimestamp(),
    seen:false
  });
  await updateDoc(doc(db,"conversations",currentChat),{
    lastMessage:text.value,
    updatedAt:serverTimestamp()
  });
  text.value="";
};
</script>

</body>
</html>
