<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>SOFI CHAT</title>
<style>
body { font-family: Arial; margin: 0; background:#f2f2f2; }
#login, #profile, #chat { display:none; padding:20px; }
#contacts div { padding:10px; border-bottom:1px solid #ccc; cursor:pointer; }
#messages { height:300px; overflow-y:auto; background:#fff; padding:10px; }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login">
  <h2>SOFI CHAT</h2>
  <button id="loginGoogle">Entrar com Google</button>
</div>

<!-- CRIAR PERFIL -->
<div id="profile">
  <h3>Escolha seu ID público</h3>
  <input id="username" placeholder="ex: fagner123" />
  <button id="saveProfile">Salvar</button>
</div>

<!-- CHAT -->
<div id="chat">
  <h3>Contatos</h3>
  <div id="contacts"></div>

  <hr>

  <h3>Chat</h3>
  <div id="messages"></div>
  <input id="msgInput" placeholder="Digite..." />
  <button id="sendMsg">Enviar</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, onSnapshot, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDwsERnH6Obpzc6Klt9r7IxDXWOkiaYSHU",
  authDomain: "sofi-chat.firebaseapp.com",
  projectId: "sofi-chat",
  storageBucket: "sofi-chat.firebasestorage.app",
  messagingSenderId: "533851013944",
  appId: "1:533851013944:web:a49900cdde03ba01dd37cd"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

const loginDiv = document.getElementById("login");
const profileDiv = document.getElementById("profile");
const chatDiv = document.getElementById("chat");
const contactsDiv = document.getElementById("contacts");
const messagesDiv = document.getElementById("messages");

let currentUser = null;
let currentChatUser = null;

document.getElementById("loginGoogle").onclick = () => {
  signInWithPopup(auth, provider);
};

onAuthStateChanged(auth, async user => {
  if (!user) {
    loginDiv.style.display = "block";
    return;
  }

  currentUser = user;
  loginDiv.style.display = "none";

  const ref = doc(db, "users", user.uid);
  const snap = await getDoc(ref);

  if (!snap.exists()) {
    profileDiv.style.display = "block";
  } else {
    chatDiv.style.display = "block";
    loadContacts();
  }
});

document.getElementById("saveProfile").onclick = async () => {
  const username = document.getElementById("username").value.trim();
  if (!username) return alert("Escolha um ID");

  await setDoc(doc(db, "users", currentUser.uid), {
    name: currentUser.displayName,
    username: username
  });

  profileDiv.style.display = "none";
  chatDiv.style.display = "block";
  loadContacts();
};

function loadContacts() {
  onSnapshot(collection(db, "users"), snapshot => {
    contactsDiv.innerHTML = "";
    snapshot.forEach(docu => {
      if (docu.id === currentUser.uid) return;
      const data = docu.data();

      const div = document.createElement("div");
      div.textContent = data.name + " (" + data.username + ")";
      div.onclick = () => openChat(docu.id);
      contactsDiv.appendChild(div);
    });
  });
}

function openChat(uid) {
  currentChatUser = uid;
  messagesDiv.innerHTML = "";

  const q = query(
    collection(db, "messages"),
    where("participants", "array-contains", currentUser.uid),
    orderBy("createdAt")
  );

  onSnapshot(q, snapshot => {
    messagesDiv.innerHTML = "";
    snapshot.forEach(docu => {
      const msg = docu.data();
      if (!msg.participants.includes(currentChatUser)) return;

      const p = document.createElement("p");
      p.textContent = msg.sender === currentUser.uid ? "Você: " + msg.text : msg.text;
      messagesDiv.appendChild(p);
    });
  });
}

document.getElementById("sendMsg").onclick = async () => {
  const text = document.getElementById("msgInput").value.trim();
  if (!text || !currentChatUser) return;

  await addDoc(collection(db, "messages"), {
    text,
    sender: currentUser.uid,
    participants: [currentUser.uid, currentChatUser],
    createdAt: serverTimestamp()
  });

  document.getElementById("msgInput").value = "";
};
</script>

</body>
</html>
