<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>SOFI CHAT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f5f7fa;
    }
    .hidden { display: none; }

    button {
      padding: 12px;
      border: none;
      border-radius: 6px;
      background: #667eea;
      color: white;
      font-size: 16px;
    }

    input {
      padding: 10px;
      width: 100%;
      margin-top: 8px;
    }

    #login, #setup, #chat {
      padding: 20px;
    }

    #contacts div {
      padding: 10px;
      background: white;
      margin-bottom: 8px;
      border-radius: 6px;
      cursor: pointer;
    }

    #messages {
      height: 60vh;
      overflow-y: auto;
      background: white;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 10px;
    }

    .me { text-align: right; color: #667eea; }
    .other { text-align: left; color: #333; }
  </style>
</head>
<body>

<div id="login">
  <h2>SOFI CHAT</h2>
  <button id="googleLogin">Entrar com Google</button>
</div>

<div id="setup" class="hidden">
  <h3>Escolha seu ID p√∫blico</h3>
  <input id="username" placeholder="ex: fagner123" />
  <button id="saveProfile">Continuar</button>
</div>

<div id="chat" class="hidden">
  <h3 id="chatTitle">Contatos</h3>
  <div id="contacts"></div>

  <div id="messages" class="hidden"></div>

  <div id="sendBox" class="hidden">
    <input id="msgInput" placeholder="Digite uma mensagem" />
    <button id="sendMsg">Enviar</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, collection, getDocs, addDoc, query, where, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDwsERnH6Obpzc6Klt9r7IxDXWOkiaYSHU",
    authDomain: "sofi-chat.firebaseapp.com",
    projectId: "sofi-chat",
    storageBucket: "sofi-chat.firebasestorage.app",
    messagingSenderId: "533851013944",
    appId: "1:533851013944:web:a49900cdde03ba01dd37cd"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const login = document.getElementById("login");
  const setup = document.getElementById("setup");
  const chat = document.getElementById("chat");

  const googleLogin = document.getElementById("googleLogin");
  const saveProfile = document.getElementById("saveProfile");

  const contactsDiv = document.getElementById("contacts");
  const messagesDiv = document.getElementById("messages");
  const sendBox = document.getElementById("sendBox");
  const msgInput = document.getElementById("msgInput");

  let currentUser = null;
  let currentChatId = null;

  googleLogin.onclick = async () => {
    const provider = new GoogleAuthProvider();
    await signInWithPopup(auth, provider);
  };

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      login.classList.remove("hidden");
      setup.classList.add("hidden");
      chat.classList.add("hidden");
      return;
    }

    currentUser = user;
    login.classList.add("hidden");

    const userRef = doc(db, "users", user.uid);
    const snap = await getDoc(userRef);

    if (!snap.exists()) {
      setup.classList.remove("hidden");
    } else {
      loadContacts();
      chat.classList.remove("hidden");
    }
  });

  saveProfile.onclick = async () => {
    const username = document.getElementById("username").value.trim();
    if (!username) return alert("Escolha um ID");

    await setDoc(doc(db, "users", currentUser.uid), {
      uid: currentUser.uid,
      name: currentUser.displayName,
      username,
      photo: currentUser.photoURL,
      createdAt: serverTimestamp()
    });

    setup.classList.add("hidden");
    loadContacts();
    chat.classList.remove("hidden");
  };

  async function loadContacts() {
    contactsDiv.innerHTML = "";
    const usersSnap = await getDocs(collection(db, "users"));

    usersSnap.forEach(docu => {
      if (docu.id === currentUser.uid) return;

      const div = document.createElement("div");
      div.textContent = docu.data().name + " (" + docu.data().username + ")";
      div.onclick = () => openChat(docu.id);
      contactsDiv.appendChild(div);
    });
  }

  function openChat(otherId) {
    currentChatId = [currentUser.uid, otherId].sort().join("_");
    messagesDiv.classList.remove("hidden");
    sendBox.classList.remove("hidden");
    messagesDiv.innerHTML = "";

    const q = query(
      collection(db, "messages"),
      where("chatId", "==", currentChatId),
      orderBy("createdAt")
    );

    onSnapshot(q, snap => {
      messagesDiv.innerHTML = "";
      snap.forEach(m => {
        const p = document.createElement("p");
        p.textContent = m.data().text;
        p.className = m.data().sender === currentUser.uid ? "me" : "other";
        messagesDiv.appendChild(p);
      });
    });
  }

  document.getElementById("sendMsg").onclick = async () => {
    const text = msgInput.value.trim();
    if (!text || !currentChatId) return;

    await addDoc(collection(db, "messages"), {
      chatId: currentChatId,
      sender: currentUser.uid,
      text,
      createdAt: serverTimestamp()
    });

    msgInput.value = "";
  };
</script>

</body>
</html>
