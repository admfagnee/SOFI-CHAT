<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SOFI Chat</title>
<style>
    * {margin:0;padding:0;box-sizing:border-box;}
    body {font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif; background:#f5f7fa; height:100vh; overflow:hidden;}
    .screen {display:none;height:100vh;justify-content:center;align-items:center;}
    .screen.active {display:flex;}
    .login-container, .username-container, .chat-container {background:white;padding:2rem;border-radius:20px;box-shadow:0 10px 20px rgba(0,0,0,0.1);width:90%;max-width:400px;text-align:center;}
    input {padding:1rem;border:2px solid #e0e0e0;border-radius:12px;width:100%;margin-bottom:1rem;font-size:1rem;}
    .btn-primary {background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;padding:1rem 2rem;border-radius:12px;font-size:1rem;cursor:pointer;width:100%;font-weight:bold;}
    .contacts-list {max-height:300px;overflow-y:auto;text-align:left;margin-bottom:1rem;}
    .contact-item {padding:0.75rem 1rem;border-radius:12px;cursor:pointer;margin-bottom:0.5rem;background:#f8f9ff;}
    .contact-item:hover {background:#e1e6ff;}
    .chat-messages {height:300px;overflow-y:auto;padding:1rem;border:1px solid #e0e0e0;border-radius:12px;margin-bottom:1rem;background:white;}
    .message.sent {background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:0.5rem 1rem;border-radius:18px;margin:5px 0;margin-left:auto;max-width:70%;}
    .message.received {background:white;color:#333;padding:0.5rem 1rem;border-radius:18px;margin:5px 0;max-width:70%;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
    .message-input {display:flex;gap:0.5rem;}
    .message-input input {flex:1;border-radius:25px;padding:0.75rem;}
    .message-input button {border:none;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border-radius:50%;width:50px;height:50px;font-size:1.2rem;cursor:pointer;}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen" class="screen active">
    <div class="login-container">
        <h1>SOFI Chat</h1>
        <p>Entre com sua conta Google</p>
        <button id="googleLogin" class="btn-primary">Entrar com Google</button>
    </div>
</div>

<!-- USERNAME -->
<div id="usernameScreen" class="screen">
    <div class="username-container">
        <h2>Escolha seu nome de usuário</h2>
        <input type="text" id="usernameInput" placeholder="Digite seu nome..." />
        <button id="saveUsername" class="btn-primary">Salvar</button>
    </div>
</div>

<!-- CHAT -->
<div id="chatScreen" class="screen">
    <div class="chat-container" style="width:100%;max-width:600px;">
        <h2>Contatos</h2>
        <div class="contacts-list" id="contactsList"></div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="message-input">
            <input type="text" id="messageInput" placeholder="Digite uma mensagem..." />
            <button id="sendMessage">➤</button>
        </div>
    </div>
</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getDatabase, ref, set, push, onValue, get, child } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDwsERnH6Obpzc6Klt9r7IxDXWOkiaYSHU",
  authDomain: "sofi-chat.firebaseapp.com",
  projectId: "sofi-chat",
  storageBucket: "sofi-chat.firebasestorage.app",
  messagingSenderId: "533851013944",
  appId: "1:533851013944:web:a49900cdde03ba01dd37cd"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getDatabase(app);
const provider = new GoogleAuthProvider();

const loginScreen = document.getElementById('loginScreen');
const usernameScreen = document.getElementById('usernameScreen');
const chatScreen = document.getElementById('chatScreen');
const usernameInput = document.getElementById('usernameInput');
const saveUsername = document.getElementById('saveUsername');
const contactsList = document.getElementById('contactsList');
const chatMessages = document.getElementById('chatMessages');
const messageInput = document.getElementById('messageInput');
const sendMessageBtn = document.getElementById('sendMessage');

let currentUser = null;
let currentChatUser = null;

// LOGIN GOOGLE
document.getElementById('googleLogin').addEventListener('click', () => {
    signInWithPopup(auth, provider).catch(console.error);
});

// ESCUTA AUTENTICAÇÃO
onAuthStateChanged(auth, async (user) => {
    if(user){
        currentUser = {uid:user.uid,email:user.email};
        // Verifica se username existe
        const userRef = ref(db, 'users/'+currentUser.uid);
        const snapshot = await get(userRef);
        if(snapshot.exists() && snapshot.val().username){
            currentUser.username = snapshot.val().username;
            showScreen(chatScreen);
            loadContacts();
        } else {
            showScreen(usernameScreen);
        }
    } else {
        showScreen(loginScreen);
    }
});

// SALVAR USERNAME
saveUsername.addEventListener('click', async () => {
    const name = usernameInput.value.trim();
    if(!name) return alert('Digite um nome válido');
    const usernameRef = ref(db, 'users/'+currentUser.uid);
    await set(usernameRef, {username:name,uid:currentUser.uid});
    currentUser.username = name;
    showScreen(chatScreen);
    loadContacts();
});

// FUNÇÃO PARA MUDAR DE TELA
function showScreen(screen){
    [loginScreen, usernameScreen, chatScreen].forEach(s=>s.classList.remove('active'));
    screen.classList.add('active');
}

// CARREGAR CONTATOS
async function loadContacts(){
    contactsList.innerHTML='';
    const usersRef = ref(db, 'users');
    onValue(usersRef, snapshot=>{
        contactsList.innerHTML='';
        snapshot.forEach(childSnap=>{
            const user = childSnap.val();
            if(user.uid!==currentUser.uid){
                const div = document.createElement('div');
                div.className='contact-item';
                div.textContent=user.username;
                div.onclick = ()=>openChat(user);
                contactsList.appendChild(div);
            }
        });
    });
}

// ABRIR CHAT PRIVADO
function openChat(user){
    currentChatUser = user;
    chatMessages.innerHTML='';
    const chatId = generateChatId(currentUser.uid,user.uid);
    const messagesRef = ref(db,'messages/'+chatId);
    onValue(messagesRef,snapshot=>{
        chatMessages.innerHTML='';
        snapshot.forEach(msgSnap=>{
            const msg = msgSnap.val();
            const div = document.createElement('div');
            div.className='message '+(msg.sender===currentUser.uid?'sent':'received');
            div.textContent=msg.text;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        });
    });
}

// ENVIAR MENSAGEM
sendMessageBtn.addEventListener('click',async()=>{
    const text = messageInput.value.trim();
    if(!text || !currentChatUser) return;
    const chatId = generateChatId(currentUser.uid,currentChatUser.uid);
    const messagesRef = ref(db,'messages/'+chatId);
    const newMsgRef = push(messagesRef);
    await set(newMsgRef,{sender:currentUser.uid,text:text,timestamp:Date.now()});
    messageInput.value='';
});

// GERAR CHAT ID ÚNICO PARA 2 PARTICIPANTES
function generateChatId(uid1,uid2){
    return [uid1,uid2].sort().join('_');
}
</script>

</body>
</html>
