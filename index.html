<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SOFI Chat</title>
<style>
/* === ESTILOS === */
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:#f5f7fa;height:100vh;overflow:hidden;}
.login-screen,.username-screen,.main-screen{display:none;height:100vh;width:100vw;justify-content:center;align-items:center;}
.login-screen.active,.username-screen.active,.main-screen.active{display:flex;}
.login-container,.username-container{background:white;padding:2rem;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,0.1);text-align:center;max-width:400px;width:90%;}
.btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;padding:1rem 2rem;border-radius:12px;font-size:1rem;cursor:pointer;width:100%;font-weight:bold;}
input{padding:1rem;border:2px solid #e0e0e0;border-radius:12px;width:100%;margin-bottom:1rem;font-size:1rem;}
.main-screen{flex-direction:row;background:white;overflow:hidden;}
.sidebar{width:350px;background:white;border-right:1px solid #e0e0e0;display:flex;flex-direction:column;}
.sidebar-header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:1.5rem;display:flex;justify-content:space-between;align-items:center;}
.conversations-list{flex:1;overflow-y:auto;padding:0.5rem;}
.conversation-item{display:flex;align-items:center;padding:1rem;border-radius:12px;cursor:pointer;margin-bottom:0.5rem;position:relative;}
.conversation-avatar{width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;margin-right:1rem;}
.conversation-name{font-weight:600;color:#333;margin-bottom:0.25rem;}
.chat-area{flex:1;display:flex;flex-direction:column;background:#f5f7fa;}
.chat-header{background:white;padding:1.5rem;border-bottom:1px solid #e0e0e0;display:flex;justify-content:space-between;align-items:center;}
.chat-user-info{display:flex;align-items:center;gap:1rem;}
.chat-avatar{width:45px;height:45px;border-radius:50%;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;}
.messages-container{flex:1;overflow-y:auto;padding:1.5rem;background:#f5f7fa;}
.message{margin-bottom:1rem;padding:0.75rem 1.25rem;border-radius:18px;max-width:70%;}
.message.sent{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;margin-left:auto;border-bottom-right-radius:4px;}
.message.received{background:white;color:#333;margin-right:auto;border-bottom-left-radius:4px;box-shadow:0 2px 10px rgba(0,0,0,0.1);}
.message-input-container{background:white;padding:1rem;border-top:1px solid #e0e0e0;display:flex;align-items:center;gap:1rem;}
#messageInput{flex:1;padding:1rem;border:2px solid #e0e0e0;border-radius:25px;font-size:1rem;}
.btn-send{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;width:50px;height:50px;border-radius:50%;cursor:pointer;font-size:1.2rem;}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen" class="login-screen active">
  <div class="login-container">
    <h1>SOFI</h1>
    <button id="googleLogin" class="btn-primary">Entrar com Google</button>
  </div>
</div>

<!-- USERNAME -->
<div id="usernameScreen" class="username-screen">
  <div class="username-container">
    <h2>Escolha seu username</h2>
    <input type="text" id="usernameInput" placeholder="Seu nome de exibiÃ§Ã£o">
    <button id="usernameBtn" class="btn-primary">Confirmar</button>
  </div>
</div>

<!-- CHAT -->
<div id="mainScreen" class="main-screen">
  <div class="sidebar">
    <div class="sidebar-header"><h2>SOFI Chat</h2></div>
    <div class="conversations-list" id="contactsList"></div>
  </div>
  <div class="chat-area">
    <div class="chat-header">
      <div class="chat-user-info">
        <div class="chat-avatar" id="currentChatAvatar">ðŸ’œ</div>
        <div>
          <h3 id="currentChatName">Selecione um contato</h3>
        </div>
      </div>
    </div>
    <div class="messages-container" id="messagesContainer"></div>
    <div class="message-input-container">
      <input type="text" id="messageInput" placeholder="Digite sua mensagem..." disabled>
      <button id="sendButton" class="btn-send" disabled>âž¤</button>
    </div>
  </div>
</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getDatabase, ref, set, push, onChildAdded, get, child, update } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDwsERnH6Obpzc6Klt9r7IxDXWOkiaYSHU",
  authDomain: "sofi-chat.firebaseapp.com",
  projectId: "sofi-chat",
  storageBucket: "sofi-chat.firebasestorage.app",
  messagingSenderId: "533851013944",
  appId: "1:533851013944:web:a49900cdde03ba01dd37cd"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getDatabase();

let currentUser = null;
let currentChat = null;

// UTIL
function showScreen(screen){
  document.getElementById('loginScreen').classList.remove('active');
  document.getElementById('usernameScreen').classList.remove('active');
  document.getElementById('mainScreen').classList.remove('active');
  screen.classList.add('active');
}

// LOGIN GOOGLE
document.getElementById('googleLogin').addEventListener('click',async()=>{
  const provider = new GoogleAuthProvider();
  try{
    await signInWithPopup(auth,provider);
  }catch(e){
    alert('Erro no login: '+e.message);
  }
});

// USERNAME
onAuthStateChanged(auth,async(user)=>{
  if(user){
    currentUser = {uid:user.uid,email:user.email};
    const userRef = ref(db,'users/'+currentUser.uid);
    const snapshot = await get(userRef);
    if(snapshot.exists() && snapshot.val().username){
      currentUser.username = snapshot.val().username;
      showScreen(document.getElementById('mainScreen'));
      loadContacts();
    } else {
      showScreen(document.getElementById('usernameScreen'));
    }
  }else{
    showScreen(document.getElementById('loginScreen'));
  }
});

document.getElementById('usernameBtn').addEventListener('click',async()=>{
  const name = document.getElementById('usernameInput').value.trim();
  if(!name){alert('Digite um nome'); return;}
  const userRef = ref(db,'users/'+currentUser.uid);
  await set(userRef,{username:name,uid:currentUser.uid,email:currentUser.email});
  currentUser.username = name;
  showScreen(document.getElementById('mainScreen'));
  loadContacts();
});

// LOAD CONTACTS
function loadContacts(){
  const list = document.getElementById('contactsList');
  list.innerHTML='';
  const usersRef = ref(db,'users');
  onChildAdded(usersRef,(snapshot)=>{
    const u = snapshot.val();
    if(u.uid !== currentUser.uid){
      const div = document.createElement('div');
      div.className='conversation-item';
      div.innerHTML=`<div class="conversation-avatar">${u.username.charAt(0).toUpperCase()}</div><div class="conversation-name">${u.username}</div>`;
      div.onclick=()=>openChat(u);
      list.appendChild(div);
    }
  });
}

// ABRIR CHAT 1x1
function openChat(u){
  currentChat = u;
  document.getElementById('currentChatName').innerText = u.username;
  document.getElementById('messageInput').disabled=false;
  document.getElementById('sendButton').disabled=false;
  loadMessages();
}

// ENVIAR MENSAGEM
document.getElementById('sendButton').addEventListener('click',sendMessage);
document.getElementById('messageInput').addEventListener('keypress',e=>{if(e.key==='Enter') sendMessage();});

function sendMessage(){
  const text = document.getElementById('messageInput').value.trim();
  if(!text || !currentChat) return;
  const chatId = [currentUser.uid,currentChat.uid].sort().join('_');
  const msgRef = ref(db,'messages/'+chatId);
  const message = {sender:currentUser.uid,text: text,time:Date.now()};
  push(msgRef,message);
  document.getElementById('messageInput').value='';
}

// LOAD MESSAGES
function loadMessages(){
  const container = document.getElementById('messagesContainer');
  container.innerHTML='';
  const chatId = [currentUser.uid,currentChat.uid].sort().join('_');
  const msgRef = ref(db,'messages/'+chatId);
  onChildAdded(msgRef,(snapshot)=>{
    const m = snapshot.val();
    const div = document.createElement('div');
    div.className = m.sender===currentUser.uid?'message sent':'message received';
    div.innerText = m.text;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
  });
}
</script>
</body>
</html>
